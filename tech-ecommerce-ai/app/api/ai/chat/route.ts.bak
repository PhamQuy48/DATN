import { NextRequest, NextResponse } from 'next/server'
import { mockProducts } from '@/lib/data/mock-products'

// Mock AI responses (since we don't have real OpenAI API key)
// In production, you would use OpenAI API

export async function POST(request: NextRequest) {
  try {
    const { message, conversationHistory } = await request.json()

    // Simulate AI processing delay
    await new Promise(resolve => setTimeout(resolve, 1000))

    // Simple keyword-based responses
    const messageLower = message.toLowerCase()

    let response = ''
    let suggestedProducts = []

    // Laptop queries
    if (messageLower.includes('laptop') || messageLower.includes('mÃ¡y tÃ­nh')) {
      response = 'ChÃºng tÃ´i cÃ³ nhiá»u laptop cao cáº¥p. Báº¡n muá»‘n tÃ¬m laptop cho cÃ´ng viá»‡c gÃ¬? Gaming, vÄƒn phÃ²ng, hay Ä‘á»“ há»a?'
      suggestedProducts = mockProducts.filter(p => p.categoryId === '1').slice(0, 3)
    }
    // Gaming queries
    else if (messageLower.includes('gaming') || messageLower.includes('chÆ¡i game')) {
      response = 'TÃ´i gá»£i Ã½ ASUS ROG Zephyrus G14 - laptop gaming má»ng nháº¹ vá»›i hiá»‡u nÄƒng máº¡nh máº½, hoáº·c Dell XPS 15 náº¿u báº¡n muá»‘n cÃ¢n báº±ng gaming vÃ  cÃ´ng viá»‡c.'
      suggestedProducts = mockProducts.filter(p =>
        p.slug === 'asus-rog-zephyrus-g14' || p.slug === 'dell-xps-15-9530'
      )
    }
    // Phone queries
    else if (messageLower.includes('Ä‘iá»‡n thoáº¡i') || messageLower.includes('phone') || messageLower.includes('smartphone')) {
      response = 'ChÃºng tÃ´i cÃ³ iPhone 15 Pro Max vÃ  Samsung Galaxy S24 Ultra - 2 flagship hÃ ng Ä‘áº§u. Báº¡n thÃ­ch há»‡ sinh thÃ¡i nÃ o?'
      suggestedProducts = mockProducts.filter(p => p.categoryId === '2')
    }
    // Apple queries
    else if (messageLower.includes('apple') || messageLower.includes('iphone') || messageLower.includes('macbook') || messageLower.includes('ipad')) {
      response = 'Apple cÃ³ nhiá»u sáº£n pháº©m tuyá»‡t vá»i! Tá»« MacBook Pro M3 Max, iPhone 15 Pro Max, Ä‘áº¿n iPad Pro M2. Báº¡n quan tÃ¢m sáº£n pháº©m nÃ o?'
      suggestedProducts = mockProducts.filter(p => p.brand === 'Apple').slice(0, 4)
    }
    // Price queries
    else if (messageLower.includes('giÃ¡') || messageLower.includes('bao nhiÃªu') || messageLower.includes('price')) {
      response = 'ChÃºng tÃ´i cÃ³ sáº£n pháº©m tá»« 2 triá»‡u (phá»¥ kiá»‡n) Ä‘áº¿n 80 triá»‡u (laptop cao cáº¥p). Báº¡n cÃ³ ngÃ¢n sÃ¡ch bao nhiÃªu?'
    }
    // Budget queries
    else if (messageLower.match(/(\d+)\s*(triá»‡u|tr|million)/)) {
      const budget = parseInt(messageLower.match(/(\d+)/)?.[1] || '0') * 1000000
      response = `Vá»›i ngÃ¢n sÃ¡ch khoáº£ng ${budget / 1000000} triá»‡u, tÃ´i gá»£i Ã½:`
      suggestedProducts = mockProducts.filter(p => {
        const price = p.salePrice || p.price
        return price <= budget * 1.2 && price >= budget * 0.5
      }).slice(0, 3)
    }
    // Accessories queries
    else if (messageLower.includes('tai nghe') || messageLower.includes('chuá»™t') || messageLower.includes('phá»¥ kiá»‡n') || messageLower.includes('airpods')) {
      response = 'ChÃºng tÃ´i cÃ³ AirPods Pro 2 vÃ  chuá»™t Logitech MX Master 3S - nhá»¯ng phá»¥ kiá»‡n cao cáº¥p nháº¥t.'
      suggestedProducts = mockProducts.filter(p => p.categoryId === '4')
    }
    // Recommendations
    else if (messageLower.includes('gá»£i Ã½') || messageLower.includes('recommend') || messageLower.includes('tÆ° váº¥n')) {
      response = 'Dá»±a trÃªn sá»Ÿ thÃ­ch cá»§a nhiá»u khÃ¡ch hÃ ng, tÃ´i gá»£i Ã½ nhá»¯ng sáº£n pháº©m hot nháº¥t:'
      suggestedProducts = mockProducts.filter(p => p.featured).slice(0, 4)
    }
    // Greetings
    else if (messageLower.includes('xin chÃ o') || messageLower.includes('hello') || messageLower.includes('hi ')) {
      response = 'Xin chÃ o! TÃ´i lÃ  trá»£ lÃ½ AI cá»§a SHOP QM. TÃ´i cÃ³ thá»ƒ giÃºp báº¡n tÃ¬m sáº£n pháº©m cÃ´ng nghá»‡ phÃ¹ há»£p. Báº¡n Ä‘ang tÃ¬m kiáº¿m gÃ¬?'
    }
    // Thanks
    else if (messageLower.includes('cáº£m Æ¡n') || messageLower.includes('thanks') || messageLower.includes('thank you')) {
      response = 'Ráº¥t vui Ä‘Æ°á»£c há»— trá»£ báº¡n! Náº¿u cÃ³ tháº¯c máº¯c gÃ¬, Ä‘á»«ng ngáº§n ngáº¡i há»i nhÃ©! ðŸ˜Š'
    }
    // Help
    else if (messageLower.includes('giÃºp') || messageLower.includes('help')) {
      response = 'TÃ´i cÃ³ thá»ƒ giÃºp báº¡n:\n\nâ€¢ TÃ¬m sáº£n pháº©m theo nhu cáº§u\nâ€¢ So sÃ¡nh sáº£n pháº©m\nâ€¢ Gá»£i Ã½ sáº£n pháº©m phÃ¹ há»£p vá»›i ngÃ¢n sÃ¡ch\nâ€¢ Tráº£ lá»i thÃ´ng tin sáº£n pháº©m\n\nBáº¡n cáº§n gÃ¬?'
    }
    // Default
    else {
      response = 'TÃ´i hiá»ƒu báº¡n Ä‘ang tÃ¬m kiáº¿m thÃ´ng tin. Báº¡n cÃ³ thá»ƒ há»i tÃ´i vá» laptop, Ä‘iá»‡n thoáº¡i, tablet, hoáº·c phá»¥ kiá»‡n. Hoáº·c cho tÃ´i biáº¿t ngÃ¢n sÃ¡ch vÃ  nhu cáº§u cá»§a báº¡n!'
      suggestedProducts = mockProducts.filter(p => p.featured).slice(0, 3)
    }

    return NextResponse.json({
      message: response,
      products: suggestedProducts,
    })
  } catch (error) {
    console.error('Error in AI chat:', error)
    return NextResponse.json(
      { error: 'Failed to process chat message' },
      { status: 500 }
    )
  }
}
